import {Note} from "../../../../components/Note";
import {ApiReader, CodeGroup, Col, Row} from "../../../../components/mdx";
export const sectionMode = 'nav';
export const apiRefs = ['/gateway/mpi/lookup', '/gateway/mpi/query']

# Proceso 3DS

### Características y/o mejoras de cada versión
* **Versión 2x**:
  * Permite crear una sesión sincrona lo que da como resultado omitir el proceso de redirección hacia páginas de verificación 3DS, ya que se incluye en la respuesta el resultado que se validaría en el servicio `gateway/mpi/query`.
  * Se definen nuevas propiedades que se pueden enviar en la solicitud lo que puede mejorar considerablemente la tasa de autenticaciones exitosas por parte del servicio 3DS.
  * Mantiene la compatibilidad con la versión 2.
* **Versión 2**:
  * Permite crear una sesión asincrona en [3DS Server](three-d-s-server) retornando una URL de verificación.
  * **Versión Obsoleta**

---

## 3DS Lookup {{ id: 'mpi-lookup-request', tag: 'POST', label: '/gateway/mpi/lookup' }}

Realiza el proceso inicial de validación de [3DS Server](/three-d-s-server/api/integration/session) retornando los datos para que el usuario pueda continuar con el proceso.
El inicio de sesión de 3DS se puede realizar en dos escenarios diferentes:
* **Suscripción**: Se usa la propiedad `subscription` con los respectivos valores propios de una suscripción.
* **Pago**: Se usa la propiedad `payment` con los respectivos valores propios de un pago.

**Tipo de sesión**

Pueden existir dos tipos de sesión de acuerdo a las validaciones realizadas por el servicio 3DS y que indicara si el titular de la tarjeta necesita hacer una autenticación adicional o no.

* **Asincrona**: Se retorna una URL de redirección para que el usuario pueda continuar con el proceso de autenticación. Se identifica por la propiedad `action` con el valor `redirect`.
* **Sincrona**: Se retorna el resultado final de la autenticación misma que se puede consultar en el servicio `gateway/mpi/query`. Se identifica por la propiedad `action` con el valor `continue`.

<Note>
    **Nota:** Estos tipos de sesión solo se aplican a la versión **2x**.
</Note>

<Row>
    <Col>
        <ApiReader
            path="/gateway/mpi/lookup"
            method="post"
            api={props.refs}
        />
    </Col>

    <Col sticky={true}>
        <CodeGroup title="Solicitud" tag="POST" label="/gateway/mpi/lookup">
            ```bash {{ title: 'Suscripción v2x' }}
            curl -X "POST" https://api-co-dev.placetopay.ws/gateway/mpi/lookup \
            -H "Content-Type: application/json" \
            -d '{
                "auth": {
                    "login": "6dd490faf9cb87a9862245da41170ff2",
                    "tranKey": "81RuiCFgrjJ5VlSzTLqyC2cekqvq7vXQQwG1131+WK0=",
                    "nonce": "bmVybzNzYms4cmE=",
                    "seed": "2024-11-21T11:30:33-05:00"
                },
                "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.212 Safari/537.36",
                "buyer": {
                    "address": {
                        "country": "CO",
                        "state": "CUN",
                        "city": "Bogota",
                        "street": "cra 75 c 57 f 55",
                        "postalCode": "110741",
                    }
                },
                "payer": {
                    "name": "payer name",
                    "surname": "payer surname",
                    "email": "email@payer.com",
                    "mobile": "+573195505458",
                    "address": {
                        "country": "CO",
                        "state": "CUN",
                        "city": "Bogota",
                        "street": "cra 75 c 57 f 55",
                        "postalCode": "110741",
                        "phone": "3195505452"
                    }
                },
                "instrument": {
                    "card": {
                        "number": "4111111111111111",
                        "expiration": "05/28",
                        "cvv": "123"
                    }
                },
                "subscription": {
                    "reference": "311161",
                    "description": "Suscripción de prueba 001"
                },
                "returnUrl": "https://www.your-site.com/return?reference=1234567890",
                "version": "v2x"
            }'
            ```

            ```bash {{ title: 'Suscripción v2' }}
            curl -X "POST" https://api-co-dev.placetopay.ws/gateway/mpi/lookup \
            -H "Content-Type: application/json" \
            -d '{
                "locale": "es_CO",
                "auth": {
                    "login":"6dd490faf9cb87a9862245da41170ff2",
                    "tranKey":"/90+dDQKT5XeVKvbjFHoGWFTQVVWHNaTdtAn9OqNXkU=",
                    "nonce":"ZGEzNHgwcGhwYm0=",
                    "seed":"2024-11-29T12:46:29-05:00"
                },
                "payer": {
                    "name": "Nombres y Apellidos",
                    "email": "email@payer.com",
                    "mobile": "+573195505458"
                },
                "instrument": {
                    "card": {
                        "number": "4111111111111111",
                        "expiration": "05/28",
                        "cvv": "123"
                    }
                },
                "returnUrl": "https://www.your-site.com/return?reference=1234567890",
                "userAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36",
            }'
            ```

            ```bash {{ title: 'Pago v2x' }}
            curl -X "POST" https://api-co-dev.placetopay.ws/gateway/mpi/lookup \
            -H "Content-Type: application/json" \
            -d '{
                "auth": {
                    "login": "6dd490faf9cb87a9862245da41170ff2",
                    "tranKey": "81RuiCFgrjJ5VlSzTLqyC2cekqvq7vXQQwG1131+WK0=",
                    "nonce": "bmVybzNzYms4cmE=",
                    "seed": "2024-11-21T11:30:33-05:00"
                },
                "buyer": {
                    "address": {
                        "country": "CO",
                        "state": "CUN",
                        "city": "Bogota",
                        "street": "cra 75 c 57 f 55",
                        "postalCode": "110741",
                    }
                },
                "payer": {
                    "name": "payer name",
                    "surname": "payer surname",
                    "email": "email@payer.com",
                    "mobile": "+573195505458",
                    "address": {
                        "country": "CO",
                        "state": "CUN",
                        "city": "Bogota",
                        "street": "cra 75 c 57 f 55",
                        "postalCode": "110741",
                        "phone": "3195505452"
                    }
                },
                "payment": {
                    "reference": "1234567890",
                    "description": "Testing payment",
                    "amount": {
                        "currency": "COP",
                        "total": 20000
                    }
                },
                "instrument": {
                    "card": {
                        "number": "4111111111111111",
                        "expiration": "05/28",
                        "cvv": "123"
                    }
                },
                "returnUrl": "https://www.your-site.com/return?reference=1234567890",
                "version": "v2x"
            }
            '
            ```

            ```bash {{ title: 'Pago v2' }}
            curl -X "POST" https://api-co-dev.placetopay.ws/gateway/mpi/lookup \
            -H "Content-Type: application/json" \
            -d '{
                "locale": "es_CO",
                "auth": {
                    "login":"6dd490faf9cb87a9862245da41170ff2",
                    "tranKey":"/90+dDQKT5XeVKvbjFHoGWFTQVVWHNaTdtAn9OqNXkU=",
                    "nonce":"ZGEzNHgwcGhwYm0=",
                    "seed":"2024-11-29T12:46:29-05:00"
                },
                "payer": {
                    "name": "Nombres y Apellidos",
                    "email": "email@payer.com",
                    "mobile": "+573195505458"
                },
                "payment": {
                        "reference": "1234567890",
                        "description": "Testing payment",
                        "amount": {
                        "currency": "COP",
                        "total": 20000
                    }
                },
                "instrument": {
                    "card": {
                        "number": "4111111111111111",
                        "expiration": "05/28",
                        "cvv": "123"
                    }
                },
                "returnUrl": "https://www.your-site.com/return?reference=1234567890",
                "userAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36",
            }'
            ```
        </CodeGroup>
    </Col>
</Row>

<Row>
    <Col>
        <ApiReader
            path="/gateway/mpi/lookup"
            method="post"
            type="response"
            api={props.refs}
        />
    </Col>

    <Col sticky={true}>
        <br />
        <CodeGroup title="Respuesta">
            ```json {{ title: 'Respuesta v2x (sesión asincrona)' }}
            {
                "status": {
                    "status": "OK",
                    "reason": "00",
                    "message": "La petición se ha procesado correctamente",
                    "date": "2021-09-21T12:09:36-05:00"
                },
                "data": {
                    "action": "redirect",
                    "version": "v2x",
                    "sessionToken": "658aa6f85dd76d0189f1a7d085fc7fbfb735ca408bdaf1f9973fe10d6c6e8f9b",
                    "redirectUrl": "https://3ds-server-to-authenticate.com/3ds",
                    "id": 262147
                }
            }
            ```

            ```json {{ title: 'Respuesta v2x (sesión sincrona)' }}
            {
                "status": {
                    "status": "OK",
                    "reason": "00",
                    "message": "La petición se ha procesado correctamente",
                    "date": "2024-12-11T13:28:50-05:00"
                },
                "data": {
                    "action": "continue",
                    "version": "v2x",
                    "id": 263238,
                    "enrolled": "Y",
                    "authenticated": "Y",
                    "eci": "07",
                    "cavv": "AAAAAAAAAAAAAAAAAAAAAAAAAAA=",
                    "xid": "3581b9b5-d6e1-4fad-abfd-0627061fde32",
                    "extra": {
                        "transStatusReason": null,
                        "acsTransId": "0850e583-9367-4712-b065-5c05540251f9",
                        "threeDSServerTransID": "273355c4-4ad7-476b-a3ed-77f094727b2b"
                    },
                    "validSignature": true
                }
            }
            ```

            ```json {{ title: 'Respuesta v2' }}
            {
                "status": {
                    "status": "OK",
                    "reason": "00",
                    "message": "La petición se ha procesado correctamente",
                    "date": "2021-09-21T11:50:46-05:00"
                },
                "data": {
                    "version": "v2",
                    "sessionToken": "658aa6f85dd76d0189f1a7d085fc7fbfb735ca408bdaf1f9973fe10d6c6e8f9b",
                    "redirectUrl": "https://3ds-server-to-authenticate.com/3ds",
                    "identifier": "262147",
                }
            }
            ```
        </CodeGroup>
    </Col>
</Row>

---

## 3DS Query {{ id: 'mpi-query-request', tag: 'POST', label: '/gateway/mpi/query' }}

Una vez que se inicia una sesión de autenticación y luego de generarse las validaciones necesarias se puede consultar el estado de la misma para determinar si el titular de la tarjeta ha sido autenticado correctamente, de igual manera una sesión sincrona se puede consultar con el identificador retornado en la respuesta del servicio `gateway/mpi/lookup`.

> ### Nota Importante
>
> *Al consumir este servicio **NO** se está autenticando la transacción por defecto, se debe tomar de la respuesta el valor de `data` y enviarlo en el `instrument.threeDS`*


<Row>
    <Col>

        <ApiReader
            path="/gateway/mpi/query"
            method="post"
            api={props.refs}
        />
    </Col>

    <Col sticky>
        <CodeGroup title="Solicitud" tag="POST" label="/gateway/mpi/query">
            ```bash {{ title: 'Consulta v2x' }}
            curl -X "POST" https://api-co-dev.placetopay.ws/gateway/mpi/lookup \
            -H "Content-Type: application/json" \
            -d '{
                "auth": {
                    "login":"6dd490faf9cb87a9862245da41170ff2",
                    "tranKey":"pctsO4oT5kxwT8VTF2fsHBtFqr7LdgBjWhoHtHjRX1k=",
                    "nonce":"NDNlZHQ5djQ3ZGs=",
                    "seed":"2024-12-11T13:28:47-05:00"
                },
                "id": 263073
            }'
            ```

            ```bash {{ title: 'Consulta v2' }}
            curl -X "POST" https://api-co-dev.placetopay.ws/gateway/mpi/lookup \
            -H "Content-Type: application/json" \
            -d '{
                "auth": {
                    "login":"6dd490faf9cb87a9862245da41170ff2",
                    "tranKey":"pctsO4oT5kxwT8VTF2fsHBtFqr7LdgBjWhoHtHjRX1k=",
                    "nonce":"NDNlZHQ5djQ3ZGs=",
                    "seed":"2024-12-11T13:28:47-05:00"
                },
                "instrument": {
                    "card": {
                        "number": "5180300000000005",
                        "expiration": "05/28",
                        "cvv": "123"
                    }
                },
                "id": 908652
            }'
            ```
        </CodeGroup>
    </Col>
</Row>

<Row>
    <Col>
        <ApiReader
            path="/gateway/mpi/query"
            method="post"
            type="response"
            api={props.refs}
        />
    </Col>

    <Col sticky>
        <br />
        <CodeGroup title="Respuesta">
            ```json {{ title: 'Respuesta v2x' }}
            {
                "status": {
                    "status": "OK",
                    "reason": "00",
                    "message": "La petición se ha procesado correctamente",
                    "date": "2024-12-11T13:28:50-05:00"
                },
                "data": {
                    "action": "continue",
                    "version": "v2x",
                    "id": 263238,
                    "enrolled": "Y",
                    "authenticated": "Y",
                    "eci": "07",
                    "cavv": "AAAAAAAAAAAAAAAAAAAAAAAAAAA=",
                    "xid": "3581b9b5-d6e1-4fad-abfd-0627061fde32",
                    "extra": {
                        "transStatusReason": null,
                        "acsTransId": "0850e583-9367-4712-b065-5c05540251f9",
                        "threeDSServerTransID": "273355c4-4ad7-476b-a3ed-77f094727b2b"
                    },
                    "validSignature": true
                }
            }
            ```

            ```json {{ title: 'Respuesta v2' }}
            {
                "status": {
                    "status": "OK",
                    "reason": "00",
                    "message": "La petición se ha procesado correctamente",
                    "date": "2021-09-21T11:40:03-05:00"
                },
                "data": {
                    "identifier": 1,
                    "enrolled": "Y",
                    "authenticated": "Y",
                    "validSignature": true,
                    "eci": "05",
                    "cavv": "AAACCZJiUGVlF4U5AmJQEwAAAAA=",
                    "xid": "604a4cde-8964-4b75-9e3d-4809cf007a60",
                    "version": "v2",
                    "extra": {
                        "transStatusReason": null,
                        "acsTransId": "bc57ca81-efec-4d8d-b9fa-103876a0a80a",
                        "threeDSServerTransID": "3eb7872e-9cb8-415c-ba9e-d69fb05160bd"
                    }
                }
            }
            ```
        </CodeGroup>
    </Col>
</Row>
