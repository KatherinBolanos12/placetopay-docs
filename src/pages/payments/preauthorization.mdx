import { HeroPattern } from '@/components/HeroPattern'
import { CenteredContainer } from '@/components/CenteredContainer'
 
export const sectionMode = 'nav';
export const description = ""

# Preautorización

La **preautorización** es una operación que permite retener temporalmente un monto en la tarjeta del cliente sin realizar un cobro inmediato. Es común en industrias como hotelería, alquiler de vehículos o servicios donde el monto final puede variar.  

Este proceso asegura que los fondos estén disponibles, sin cobrarlos hasta que se confirme el monto final. La preautorización puede ajustarse en caso de cambios, y eventualmente cobrarse o cancelarse según corresponda.

---

## Flujo general

1. **Check-in (Autorización inicial):** se solicita una autorización para reservar fondos en la tarjeta del cliente.  
2. **Reautorización (ajuste opcional):** si cambia el valor del servicio (por ejemplo, por una estadía más larga), se puede actualizar el monto retenido.  
3. **Check-out (captura):** cuando se confirma el monto final, se realiza el cobro. Si el monto final es 0, la retención se libera.

![Flujo](/GatewayFlow.png)

>  En todo momento, si ocurre un error en alguna operación, esta puede reintentarse. Las operaciones fallidas quedan con un estado específico de rechazo y no afectan las anteriores.

## Check-in

El **check-in** es la primera etapa del proceso. Consiste en realizar una preautorización por un monto específico, que actúa como un depósito de garantía.  

Una vez aprobada, esta autorización queda asociada a una referencia única que se reutiliza en los pasos siguientes.

La pre-autorización quedará en esta **pendiente** hasta que se realice un **CHECKOUT**.

<Tabs title="Checkin">
  <Tabs.Item title="Web Checkout">
    - La propiedad **"action"** debe ser `checkin`.
    - La referencia del pago se reutilizará en las operaciones de **REAUTHORIZATION** y **CHECKOUT**.
    - La moneda del pago también se mantendrá en **REAUTHORIZATION** y **CHECKOUT**.
    - No se permiten pagos de preautorización cuando se quiere hacer un pago mixto.
    - No se permiten pagos de preautorización con valores de dispersión.

    ```json {{ 'title': 'CreateSessionRequest - Preauthorization Payment' }}
    {
        ...
        "type": "checkin",
        "payment": {
            "reference": "PAY_ABC_1287",
            "description": "Pago por Placetopay",
            "amount": {
                "currency": "USD",
                "total": 1000
            }
        }
        ...
    }
    ```
  </Tabs.Item>
  <Tabs.Item title="Gateway">
    ### Solicitud Checkin (Request)

    Para facilitar la integración, las solicitudes de **CHECKIN** son similares a las del método `processTransaction`, con las siguientes diferencias:

    - La **"action"** debe ser `checkin`.
    - La referencia del pago se reutilizará en las operaciones de **REAUTHORIZATION** y **CHECKOUT**.
    - La moneda del pago también se mantendrá en **REAUTHORIZATION** y **CHECKOUT**.
    - No se considerarán detalles sobre **dispersión** (transacciones a múltiples recaudadores con la misma información del tarjetahabiente).
    - No se incluirán detalles de **recurrencia** (cobros recurrentes desde una base de datos propietaria).

    > **IMPORTANTE:** El nodo `preAuthorization` contiene los datos que se usarán en las operaciones posteriores de **REAUTHORIZATION** y **CHECKOUT**. Además, refleja el estado general del proceso de pre-autorización.
  </Tabs.Item>
</Tabs>

## Reautorización

La **reautorización** permite cambiar el monto retenido del checkin inicial o reautorización anterior.

> No aplica a Puerto Rico

> Para Transerver Retail, las reautorizaciones están limitadas únicamente a ajustes incrementales al monto previamente autorizado durante el proceso de CHECKIN o en una REAUTHORIZATION anterior.  
> Esto significa que no es posible reducir el valor autorizado. Si se intenta realizar una reautorización con un monto igual o menor al previamente autorizado, la transacción será fallida; en dado caso de requerir procesar un monto menor, se debe utilizar directamente un proceso de CHECKOUT.  

<Tabs title="Reautorización">
  <Tabs.Item title="Web Checkout">
    - La referencia del pago se sobrescribe con la sesión **CHECKIN** original.
    - La moneda del pago también se sobrescribe con la sesión **CHECKIN** original.
    - Los valores de `internalReference` y `authorization` deben ser los entregados en la respuesta de **CHECKIN** dentro del nodo `preAuthorization`.
    - Se pueden realizar varias **REAUTHORIZATION** antes del **CHECKOUT**.
    - Las reautorizaciones deben ser por un monto mayor a `0`.

    Tras esta operación, la pre-autorización sigue en estado **pendiente** hasta que se realice un **CHECKOUT**.

    ```json {{ 'title': 'TransactionActionRequest - Reauthorization' }}
    {
        ...
        "internalReference": 1, //código de referencia interna
        "amount": {
            "currency": "USD",
            "total": 100
        },
        "action": "reauthorization"
        ...
    }
    ```
  </Tabs.Item>
  <Tabs.Item title="Gateway">
   ### Solicitud Reautorización (Request)

    Para procesar una **REAUTHORIZATION** es necesario haber realizado previamente un **CHECKIN**. Consideraciones:

    - La referencia del pago se sobrescribe con la sesión **CHECKIN** original.
    - La moneda del pago también se sobrescribe con la sesión **CHECKIN** original.
    - Los valores de `internalReference` y `authorization` deben ser los entregados en la respuesta de **CHECKIN** dentro del nodo `preAuthorization`.
    - Se pueden realizar varias **REAUTHORIZATION** antes del **CHECKOUT**.
    - Las reautorizaciones deben ser por un monto mayor a `0`.

    Tras esta operación, la pre-autorización sigue en estado **pendiente** hasta que se realice un **CHECKOUT**.
  </Tabs.Item>
</Tabs>

## Check-out

El **checkout** representa el final del proceso. Es cuando decides capturar (cobrar) el monto retenido o liberar la retención.

- Es obligatorio haber hecho al menos un checkin inicial.
- No es obligatorio realizar una reautorización previa para completar una captura.

<Tabs title="Checkout">
  <Tabs.Item title="Web Checkout">
    - Es posible hacer un **CHECKOUT** sin haber realizado una **REAUTHORIZATION**.
    - La referencia del pago se sobrescribe con la sesión **CHECKIN** original.
    - La moneda del pago se sobrescribe con la sesión **CHECKIN** original.
    - Los valores de `internalReference` y `authorization` deben ser los entregados en la respuesta de **CHECKIN** dentro del nodo `preAuthorization`.
    - Si el valor del **CHECKOUT** es `0`, la pre-autorización se cancela y se libera el monto retenido en las peticiones previas.

    ```json {{ 'title': 'TransactionActionRequest - Reauthorization' }}
    {
        ...
        "internalReference": 1, //código de referencia interna
        "amount": {
            "currency": "USD",
            "total": 100
        },
        "action": "checkout"
        ...
    }
    ```
  </Tabs.Item>
  <Tabs.Item title="Gateway">
   ### Solicitud Check-out (Request)

    Consideraciones importantes:

    - Es posible hacer un **CHECKOUT** sin haber realizado una **REAUTHORIZATION**.
    - La referencia del pago se sobrescribe con la sesión **CHECKIN** original.
    - La moneda del pago se sobrescribe con la sesión **CHECKIN** original.
    - Los valores de `internalReference` y `authorization` deben ser los entregados en la respuesta de **CHECKIN** dentro del nodo `preAuthorization`.
    - Si el valor del **CHECKOUT** es `0`, la pre-autorización se cancela y se libera el monto retenido en las peticiones previas.
    
    > **IMPORTANTE:**  El estado de `status`, `authorization` y `receipt` dentro del nodo `preAuthorization` cambia tras un **CHECKOUT** exitoso. En solicitudes de **REVERSE**, se deben usar los nuevos valores generados.
  </Tabs.Item>
</Tabs>
